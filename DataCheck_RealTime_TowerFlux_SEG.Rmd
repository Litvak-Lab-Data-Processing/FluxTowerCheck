---
title: "SEG Site Data Check"
author: "Litvak Lab"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# load required libraries
library(flexdashboard)
library(data.table)
library(ggplot2)
library(gridExtra)
library(lubridate)
library(plotly)
library(tidyr)
library(shiny)
library(units)
library(dplyr)

# ENTER YEAR TO CHECK HERE
yeartocheck <- 2025

# ENTER SITE TO CHECK HERE (capital first letter, lowercase after)
site <- "Seg"

# get windrose function, source directly from Github
#source("~/Desktop/R/R_programs/Functions/plot.windrose.R")
source(paste0("https://raw.githubusercontent.com/MargueriteM/R_functions/master/plot.windrose.R"))

#basedir <- paste0("C:/FluxTowerData/", site, "/") # for Jakes computer
basedir <- paste0("~/Desktop/FluxTowerTest/", site, "/")
setwd <- basedir

# Check if the directory exists
if (!dir.exists(basedir)) {
  # Create the directory
  dir.create(basedir, recursive = TRUE)
  message("Directory created: ", basedir)
}

## these are for Vcp, add a loop to fetch for other sites - RD 
file_id <- c("162RxRaO8GO_Jbl4-Ie1MHliA642ncBaK")  # file ID from google drive 
# file_names <- c(paste0(basedir, "toa5/flux.csv"))  # Corresponding file names; ## this is for Jake's computer
toa5dir <- paste0(basedir, "toa5/")
file_name <- c(paste0(basedir, "toa5/flux.csv"))
file_name_soil <- c(paste0(basedir, "toa5/soil.csv"))
if (!dir.exists(toa5dir)) {
  # Create the directory
  dir.create(toa5dir, recursive = TRUE)
  message("Directory created: ", toa5dir)
}


# Loop through file IDs to download
file_url <- paste0("https://drive.google.com/uc?id=", file_id)
destfile <- file_name
# Check if the destination file exists, and remove it if so
if (file.exists(destfile)) {
    file.remove(destfile)
}
download.file(file_url, destfile, mode = "wb")

# import data directly from google drive
flux_colnames <- fread(paste0(basedir,"/toa5/flux.csv"),
                  header = TRUE, skip=1,sep=",", fill=TRUE,
                 na.strings=c(-9999,"#NAME?"))[1,]

flux_units <- flux_colnames[1,]
flux <- fread(paste0(basedir,"/toa5/flux.csv"),
                  header = FALSE, skip=2, sep=",", fill=TRUE,
                 na.strings=c(-9999,"#NAME?"),
              col.names=colnames(flux_colnames))
flux <- read.csv(paste0(basedir, "/toa5/flux.csv"), header = FALSE, skip = 4)
colnames(flux) <- colnames(flux_colnames)

flux <- data.table(flux)

#convert to numeric 
flux[, 2:ncol(flux) := lapply(.SD, function(x) {
  as.numeric(as.character(x))
}), .SDcols = 2:ncol(flux)]

#convert timestamp to posix
flux$TIMESTAMP <- format(as.POSIXct(flux$TIMESTAMP, tz="MST"), format="%Y-%m-%d %H:%M:%S")
flux <- subset(flux, year(flux$TIMESTAMP) == yeartocheck)

# create derivative date columns
flux[,':=' (year = year(TIMESTAMP), doy = yday(TIMESTAMP), date = as.Date(TIMESTAMP))]
flux$date_time = ymd_hms(flux$TIMESTAMP)

# calculate CO2 ppm from CO2_mean (mg/m^3) 
# https://www.teesing.com/en/page/library/tools/ppm-mg3-converter
flux[,CO2_ppm := (co22_mean_Avg/0.0409)/44.01]

# grab soil data columns 
## currently only set up for Vcp
swc_columns <- c(grep("^SWC_", names(flux), value = TRUE), "TIMESTAMP")
soilT_columns <- c(grep("^SoilT", names(flux), value=TRUE), "TIMESTAMP")
soilC_columns <- c(grep("^Soil_CO2", names(flux), value=TRUE), "TIMESTAMP")
soilHF <- c(grep("^shf_", names(flux), value = TRUE), "TIMESTAMP")
soilTCav <- c(grep("^TCAV_", names(flux), value = TRUE), "TIMESTAMP")

soil_SWC <- flux[, ..swc_columns]
soil_t <- flux[, ..soilT_columns]
soil_C <- flux[, ..soilC_columns]
soil_hf <- flux[, ..soilHF]
soil_tcav <- flux[, ..soilTCav]

# convert to long format
soilSWC <- soil_SWC %>%
  pivot_longer(-c(TIMESTAMP),names_to="IDcol") %>%
  separate(IDcol, c("metric","pit","depth"), sep="_")
soilSWC <- soilSWC %>%
  separate(pit, into = c("pit_type", "pit_num"), sep = "(?<=\\D)(?=\\d)")
soilSWC$pit_type <- ifelse(soilSWC$pit_type=="G", "grass", "open") 

soilT <- soil_t %>%
  pivot_longer(-c(TIMESTAMP),names_to="IDcol") %>%
  separate(IDcol, c("metric","pit","depth"), sep="_")
soilT <- soilT %>%
  separate(pit, into = c("pit_type", "pit_num"), sep = "(?<=\\D)(?=\\d)")
soilT$pit_type <- ifelse(soilT$pit_type=="G", "grass", "open") 

soilCO2 <- soil_C %>%
  pivot_longer(-c(TIMESTAMP),names_to="IDcol") %>%
  separate(IDcol, c(NA, "metric","pit","depth"), sep="_")
soilCO2 <- soilCO2 %>%
  separate(pit, into = c("pit_type", "pit_num"), sep = "(?<=\\D)(?=\\d)")
soilCO2$pit_type <- ifelse(soilCO2$pit_type=="Surface", "Surface_Avg", soilCO2$pit_type )
soilCO2$pit_num <- ifelse(soilCO2$pit_type=="Surface_Avg", "Average", soilCO2$pit_num )

soilHF <- soil_hf %>%
  pivot_longer(-c(TIMESTAMP),names_to="IDcol") %>%
  separate(IDcol, c("metric","pit_type","pit_num", "depth"), sep="_")

soilTCav <- soil_tcav %>%
  pivot_longer(-c(TIMESTAMP),names_to="IDcol") %>%
  separate(IDcol, c("metric","pit_type","pit_num", "depth"), sep="_")

soil <- rbind(soilSWC, soilT, soilCO2, soilHF, soilTCav)

# format date/time and create depth labels for probes
soil <- soil %>%
  mutate(date_time = ymd_hms(TIMESTAMP),
         date = as.Date(date_time)) 

```
# Plot Tower Flux and Met Data

Column {.sidebar}
---------------------------------------

###Select Date Range and variables

These graphs show most recent incoming eddy covariance and ancillary data from the tower at the X site. Data are 30min mean values.

**Note: Flux calculations are preliminary and for visualization only!!** 

#### Last timestamp when data sent to server:

```{r, echo=FALSE, warning=FALSE, message=FALSE}

print(max(flux$TIMESTAMP))
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}

dateRangeInput("daterange", "Date range:",
                 start = min(flux$date),
                 end   = max(flux$date),
                 min = min(flux$date),
                 max = max(flux$date))

radioButtons("variable1", "Flux variables:",
             c("CO2 Flux WPL (mg/m2/sec)" = "Fc_wpl",
               "CO2 mean concentration 1 (open path) (mg/m3)" = "co2_mean_Avg",
               "CO2 mean concentration 2 (closed path) (mg/m3)" = "co22_mean_Avg",
               "CO2 mean ppm (open path)" = "CO2_ppm",
               "Sensible Heat WPL (W/m2)" = "Hc",
               "Latent Heat WPL (W/m2)" = "LE_wpl",
               "H2O mean concentration 1 (open path) (g/m3)" = "h2o_mean_Avg",
               "H2O mean concentration 2 (closed path) (g/m3)" = "h2o2_mean_Avg",
               "U star" = "u_star"))
```
**When implementing range filter, missing values get connected by a line.**
```{r, echo=FALSE, warning=FALSE, message=FALSE}
 numericInput("range_flux_max","Max range of flux graph",
          value = 1000)

 numericInput("range_flux_min","Min range of flux graph",
            value = -50)

radioButtons("variable1_2", "Sonic Anemometer variables:",
             c("Ux" = "Ux_Avg",
               "Uy" = "Uy_Avg",
               "Uz" = "Uz_Avg"))

 numericInput("range_sonic_max","Max range of Sonic graph",
           value = 30)

 numericInput("range_sonic_min","Min range of Sonic graph",
             value =  -30)

# Choose biomet variable
radioButtons("variable2", "Biomet variables:",
             c("Air temperature, RTD (C)" = "RTD_temp_Avg", 
               "Air temperature, sonic (C)" = "Ts_Avg",
               "Precipitation (mm)" = "rain_tot",
               "Atmospheric pressure (kPa)" = "press1_Avg",
               "Atmospheric pressure 2 (kPa)" = "press2_Avg",
               "PAR out (W/m2)" = "par_facedown_Avg",
               "PAR in (W/m2)" = "par_faceup_Avg",
               "Short Wave IN (W/m2)" = "Rad_short_Up_Avg",
               "Short Wave OUT (W/m2)" = "Rad_short_Dn_Avg",
               "Long Wave IN (W/m2)" = "Rad_long_Up__Avg",
               "Long Wave OUT (W/m2)" = "Rad_long_Dn__Avg",
              "Wind Speed (m/s)" = "rslt_wnd_spd",
              "Wind Direction (degrees)" = "wnd_dir_compass",
              "Relative Humidity 4p5" = "RH_hmp_Avg"))

numericInput("range_met_max","Max range of Biomet graph",
           value = 40)

numericInput("range_met_min","Min range of Biomet graph",
           value = -20)

radioButtons("variable3", "Instrument variables:",
             c("Battery bank avg (V)" = "battbank_Avg",
               "Battery Bank 8100 avg (V)" = "battbank_8100_Avg",
               "Battery Bank 1000x (V)" = "batt_1000x_Avg", 
               "AGC/signal strength (open path) (unitless)" = "agc_Avg",
               "AGC/signal 2 (closed path) strength (unitless)" = "agc2_Avg",
               "IRGA warnings"="irga_warnings",
               "IRGA 2 Temp In" = "irga2_Tin_Avg",
               "IRGA 2 Temp Out" = "irga2_Tout_Avg",
               "IRGA 2 flow avg (L/min)" = "irga2_flow_lpm_Avg",
               "IRGA 2 drive" = "irga2_drive_per_Avg",
               "CSAT warnings" = "csat_warnings",
               "Datalogger Panel Voltage (V)" = "panelV_Avg",
               "n tot" = "n_Tot",
               "watchdog 1000" = "watchdog_1000x_Tot",
               "irga flow lpm Acg" = "irga2_flow_lpm_Avg",
               "free card space (Mb)"= "crdMbFree",
               "Chopper F total" = "chopper_f_Tot",
               "CSAT warnings" = "csat_warnings",
               "Panel Temp 1000 Avg" = "panelT_1000x_Avg",
               "panel V avg" = "panelV_Avg",
               "Low 12V 1000x Tot"= "low12V_1000x_Tot",
               "Skipped Scan" = "SkippedScan",
               "card free space (Mb)" = "crdMbFree",
               "crdFlag_Tot" = "crdFlag_Tot"
               ))

 
```


Column
-------------------------------------------------------------
```{r, echo = FALSE, warning = FALSE, message = FALSE}
# flux plot
renderPlotly({
    c <- flux[date >= input$daterange[[1]] & date <= input$daterange[[2]],.SD,.SDcols=c("date_time","TIMESTAMP",input$variable1)]
    
    setnames(c,input$variable1,"selected")
  # can filter for input range here or in ggplot below
   c <- c[selected>=input$range_flux_min & selected<=input$range_flux_max,]
    
  # plot_ly(c,x=~date_time,y=~airtemp, type="scatter")},
  # ggplot(c[selected>=input$range_flux_min & selected<=input$range_flux_max,], aes(date_time, selected))+
    fluxP <- ggplotly(ggplot(c, aes(date_time, selected))+
    geom_line()+
    labs(title = "Flux variables", y=input$variable1)+
      theme_bw())
 ggplotly(fluxP)
 })

# sonic plot
renderPlotly({
    c <- flux[date >= input$daterange[[1]] & date <= input$daterange[[2]],.SD,.SDcols=c("date","date_time",input$variable1_2)]
  
    setnames(c,input$variable1_2,"selected")
  
  # plot_ly(c,x=~date_time,y=~airtemp, type="scatter")},
  # ggplot(c[selected>=input$range_sonic_min & selected<=input$range_sonic_max,], aes(date_time, selected))+
  SonicP <- ggplot(c, aes(date_time, selected))+
     geom_line()+
    labs(title = "Sonic Anemomemter Orthogonal Wind Directions x, y, z", y=input$variable1_2)+
 theme_bw()
 ggplotly(SonicP)  })

# biomet variable plot
renderPlotly({
    c <- flux[date >= input$daterange[[1]] & date <= input$daterange[[2]],.SD,.SDcols=c("date","date_time",input$variable2)]
  
    setnames(c,input$variable2,"selected")
  
  # plot_ly(c,x=~date_time,y=~airtemp, type="scatter")},
  # ggplot(c[selected>=input$range_met_min & selected<=input$range_met_max,], aes(date_time, selected))+
   BiometP1 <- ggplot(c, aes(date_time, selected))+
     geom_line()+
    labs(title = "Biomet variables", y=input$variable2)+
 theme_bw()
   ggplotly(BiometP1)})

# diagnostics plot
renderPlotly({
    c <- flux[date >= input$daterange[[1]] & date <= input$daterange[[2]],.SD,.SDcols=c("date","date_time",input$variable3)]
  
    setnames(c,input$variable3,"selected")
  
  InstP <- ggplot(c, aes(date_time, selected))+
    geom_line()+
    labs(title = "Instrument variables", y=input$variable3)+
 theme_bw()
  ggplotly(InstP)})
```


# Windrose {data-orientation=rows}

Row {data-height=75}
-------------------------------------------------------------
Select Date Range for Wind Rose
```{r, echo=FALSE, warning=FALSE, message=FALSE}

dateRangeInput("daterange2", "Date range:",
                 start = min(flux$date),
                 end   = max(flux$date),
                 min = min(flux$date),
                 max = max(flux$date))

```

Row {data-height=450}
-------------------------------------------------------------
Wind Rose in Compass direction
```{r, echo = FALSE, warning = FALSE, message = FALSE}
# Wind direction from Sonic Anemometer
 renderPlot({
 wind.data <-  flux %>%
   filter((date >= input$daterange2[[1]] & date <= input$daterange2[[2]])) 
 # plot wind variables in windrose
   plot.windrose(wind.data,wind.data$rslt_wnd_spd,wind.data$wnd_dir_compass) +
   labs(title="CSAT3")+
     theme(legend.position="bottom")
 })

#renderPlot({
#wind.data <-  flux %>%
# filter((date >= input$daterange2[[1]] & date <= input$daterange2[[2]]))
# plot wind variables in windrose
#  plot.windrose(wind.data,wind.data$rslt_wnd_spd,wind.data$std_wnd_dir)+
#  labs(title="2-D Anemometer")+
#     theme(legend.position="bottom")
#})

```


# Tower Soil Moisture Profile and Met Data

Column {.sidebar}
---------------------------------------

#### Last timestamp when data sent to server:

```{r, echo=FALSE, warning=FALSE, message=FALSE}

print(max(soil$date_time))
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}

dateRangeInput("daterange3", "Date range:",
                 start = min(soil$date),
                 end   = max(soil$date),
                 min = min(soil$date),
                 max = max(soil$date))


radioButtons("variable1_3", "Soil variables:",
             c("Temperature (C)" = "SoilT",
               "Volumetric Water Content m3/m3)" = "SWC",
               "Soil CO2" = "CO2",
               "Soil heat flux", "shf",
               "Soil heat storage" = "TCAV"))

radioButtons("variable2_3", "Soil Depth:",
             c("2.5cm"="2p5",
               "12.5cm"= "12p5",
               "22.5cm"="22p5",
               "37.5cm"="37p5",
               "52.5cm"= "52p5",
               "Avg" = "Avg"))

radioButtons("variable3_3", "Biomet variables:",
             c("Air temperature, RTD (C)" = "RTD_temp_Avg", 
               "Air temperature, sonic (C)" = "Ts_Avg",
               "Precipitation (mm)" = "rain_tot",
               "Atmospheric pressure (kPa)" = "press1_Avg",
               "Atmospheric pressure 2 (kPa)" = "press2_Avg",
               "PAR out (W/m2)" = "par_facedown_Avg",
               "PAR in (W/m2)" = "par_faceup_Avg",
               "Short Wave IN (W/m2)" = "Rad_short_Up_Avg",
               "Short Wave OUT (W/m2)" = "Rad_short_Dn_Avg",
               "Long Wave IN (W/m2)" = "Rad_long_Up__Avg",
               "Long Wave OUT (W/m2)" = "Rad_long_Dn__Avg",
              "Wind Speed (m/s)" = "rslt_wnd_spd",
              "Wind Direction (degrees)" = "wnd_dir_compass",
              "Relative Humidity 4p5" = "RH_hmp_Avg"))


```

Column 
---------------------------------------

```{r, echo=FALSE, warning=FALSE, message=FALSE}

 # Soil Plot, All depths in one 
renderPlot({
     soil %>%
       filter((date >= input$daterange3[[1]] & date <= input$daterange3[[2]]) & 
     metric==input$variable1_3) %>%
  ggplot(., aes(date_time, value, colour=factor(depth), linetype = factor(pit_num)))+
      geom_line()+
    facet_wrap(pit_type~., ncol = 1) +
     labs(title = "All Depths", y=input$variable1_3)+
  theme_bw()+
     theme(legend.position="bottom")
   }, 
 height=600)

# Soil Plot, select single depth
renderPlot({
    soil %>%
      filter((date >= input$daterange3[[1]] & date <= input$daterange3[[2]]) & 
    metric==input$variable1_3 &
      depth==input$variable2_3) %>%
    
   ggplot(., aes(date_time, value, colour=factor(depth), linetype = factor(pit_num)))+
     geom_line()+
    labs(title = "Selected Depth", y=input$variable1_3)+
         facet_grid(depth~., scales="free_y")+
 theme_bw()+
    theme(legend.position="bottom")
  })

# biomet variable plot
renderPlotly({
    c <- flux[date >= input$daterange3[[1]] & date <= input$daterange3[[2]],.SD,.SDcols=c("date","date_time",input$variable3_3)]
  
    setnames(c,input$variable3_3,"selected")
  
  # plot_ly(c,x=~date_time,y=~airtemp, type="scatter")},
  # ggplot(c[selected>=input$range_met_min & selected<=input$range_met_max,], aes(date_time, selected))+
   soilmetP <- ggplot(c, aes(date_time, selected))+
     geom_line()+
    labs(title = "Biomet variables", y=input$variable3_3)+
 theme_bw()
   ggplotly(soilmetP)})

```
